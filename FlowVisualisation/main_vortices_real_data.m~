%% Spectral clustering from generalized diffusion maps:
% Authors: Ralf Banisch, Zofia Trstanova 2017
% Analysis of two data sets that are imported in files experimental_data
% or experimental_data_crossflowplane

clear all;
clc;
close all;

if(exist('Figures')==0)
    mkdir('Figures')
end

% for experimental_data choose 1
exampleID=2; 

% create figure names according to the chosen data set
    experimental_data;
    exampleName='Figures/SIDE_2_';
    epsilon=2.0;
    beta=0.5;

MyFontSize=14;

%%

data=[X,Y];
velocities=[U, V];

cd ..
cd('GDFM')
% compute the local kernel and spectral decomposition 

[evals,evec]=LKDmap(data, velocities, epsilon, beta);
cd ('../FlowVisualisation');

%%
% plot eigenvalues
figure(12);
hold on
plot(evals, '*')
xlabel('index')
ylabel('Eigenvalue')
set(gca, 'FontSize', MyFontSize)
print([exampleName,'eigenvalue'],'-depsc')


%%
% visualise first 13 eigenvectors: use this part to identify 4
% characteristic eigenvectors that will be used for clustering
figure(31)
title(['Eigenvectors 2-5 ']);
subplot(221)
hold on
scatter(data(:,1), data(:,2), 5, evec(:,2))
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
subplot(222)
scatter(data(:,1), data(:,2), 5, evec(:,3))
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
subplot(223)
scatter(data(:,1), data(:,2), 5, evec(:,4))
if(exampleID==1)
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
subplot(224)
scatter(data(:,1), data(:,2), 5, evec(:,5))
xlabel('X')
ylabel('Y')
if(exampleID==1)
    hold on
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
print([exampleName,'ev_2to5'],'-depsc')


figure(32)
title(['Eigenvectors 6-9 ']);
subplot(221)
hold on
scatter(data(:,1), data(:,2), 5, evec(:,6))
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
subplot(222)
scatter(data(:,1), data(:,2), 5, evec(:,7))
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
subplot(223)
scatter(data(:,1), data(:,2), 5, evec(:,8))
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
subplot(224)
scatter(data(:,1), data(:,2), 5, evec(:,9))
xlabel('X')
ylabel('Y')
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
print([exampleName,'ev_6to9'],'-depsc')


figure(33)
title(['Eigenvectors 10-13 ']);
subplot(221)
hold on
scatter(data(:,1), data(:,2), 5, evec(:,10))
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
subplot(222)
scatter(data(:,1), data(:,2), 5, evec(:,11))
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
subplot(223)
scatter(data(:,1), data(:,2), 5, evec(:,12))
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
subplot(224)
scatter(data(:,1), data(:,2), 5, evec(:,13))
xlabel('X')
ylabel('Y')
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
print([exampleName,'ev_10to13'],'-depsc')

%%
% plot chosen eigenvectors
%default  
ievidx=[2 3 4 5];

if (exampleID==1)
    ievidx=[2,5,7, 11, 12];
elseif (exampleID==2)
    ievidx=[2 3 4 5 6];
end

%%

strslColor='k';
strSlWDTH=0.1;
nrSlWDTH=0.3;


figure(50)
subplot(221)
hold on
scatter(data(:,1), data(:,2), 5, evec(:,ievidx(1)))
hold on
hlines =streamslice(Xres, Yres, Ures,Vres, nrSlWDTH);
set(hlines,'LineWidth',strSlWDTH,'Color',strslColor)
hold on
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
title(['\psi_{', num2str(ievidx(1)-1), '}'], 'Fontsize', MyFontSize)
xlabel('X')
ylabel('Y')

subplot(222)
scatter(data(:,1), data(:,2), 5, evec(:,ievidx(2)))
hold on
hlines =streamslice(Xres, Yres, Ures,Vres, nrSlWDTH);
set(hlines,'LineWidth',strSlWDTH,'Color',strslColor)
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
title(['\psi_{', num2str(ievidx(2)-1), '}'], 'Fontsize', MyFontSize)
xlabel('X')
ylabel('Y')

subplot(223)
scatter(data(:,1), data(:,2), 5, evec(:,ievidx(3)))
hold on
hlines =streamslice(Xres, Yres, Ures,Vres, nrSlWDTH);
set(hlines,'LineWidth',strSlWDTH,'Color',strslColor)
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
title(['\psi_{', num2str(ievidx(3)-1), '}'], 'Fontsize', MyFontSize)
xlabel('X')
ylabel('Y')


subplot(224)
scatter(data(:,1), data(:,2), 5, evec(:,ievidx(4)))
hold on
hlines =streamslice(Xres, Yres, Ures,Vres, nrSlWDTH);
set(hlines,'LineWidth',strSlWDTH,'Color',strslColor)
hold on
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end
title(['\psi_{', num2str(ievidx(4)-1), '}'], 'Fontsize', MyFontSize)
xlabel('X')
ylabel('Y')

print([exampleName,'chosen_ev'],'-depsc')

%%
% cluster data using kmeans with respect to the selected eigenvectors
% and plot chosen eigenvectors
         
if (exampleID ==3)
    
    IDX = kmeans(horzcat(real(evec(:,ievidx(1))),real(evec(:,ievidx(2))), real(evec(:,ievidx(3))),real(evec(:,ievidx(4)))),6,'replicates',100);
    
elseif(exampleID==2)
    
    IDX = kmeans(horzcat(real(evec(:,ievidx(1))),real(evec(:,ievidx(2))), real(evec(:,ievidx(3))),real(evec(:,ievidx(4)))),15,'replicates',100);
      
end

%%
% plot clustering


strslColor='k';
strSlWDTH=0.5;
nrSlWDTH=1;


figure(41)
hold on
set(gca, 'FontSize', MyFontSize)
h=pcolor(Xres, Yres, reshape(IDX, xlen, ylen)');
set(h, 'EdgeColor', 'none')
xlabel('X')
ylabel('Y')
hold on
hlines =streamslice(Xres, Yres, Ures,Vres, nrSlWDTH);
set(hlines,'LineWidth',strSlWDTH,'Color',strslColor)
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end

print([exampleName,'vortex_clustered'],'-depsc')



%%
% plot the dominant eigenvector only
dominantEVidx=2;
figure(101)
Vplot = real(evec(:,dominantEVidx));
Vplot = Vplot - (min(Vplot) + max(Vplot))/2;
Vplot = Vplot/max(Vplot);
hold on
contourf(Xres, Yres, reshape(Vplot, xlen, ylen)',50,'Linestyle','None')
contour(Xres, Yres, reshape(Vplot, xlen, ylen)',0.9*[min(Vplot), 0, max(Vplot)],'w','Linewidth',1)

set(gca, 'FontSize', MyFontSize)
hold on
streamslice(Xres, Yres, Ures,Vres)
hold on
 
    pl=patch(geometry,'FaceColor', [0.5,0.5,0.5], 'EdgeColor',[0.5,0.5,0.5],'faceAlpha',1,'HandleVisibility','off');
    xlim([X(1) X(end)])
    ylim([Y(1) Y(end)])

end

print([exampleName, 'EV2'],'-depsc')

